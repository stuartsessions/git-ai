name: Install Scripts (Local Build)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  merge_group:
    branches: [main]

jobs:
  install-local-unix:
    name: Local install.sh on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build git-ai
        run: cargo build --release --bin git-ai

      - name: Prepare test home and fake Claude Code
        run: |
          TEST_HOME="$RUNNER_TEMP/git-ai-home"
          mkdir -p "$TEST_HOME/.config/fish" "$TEST_HOME/.claude"
          touch "$TEST_HOME/.bashrc" "$TEST_HOME/.zshrc" "$TEST_HOME/.config/fish/config.fish"
          echo "HOME=$TEST_HOME" >> "$GITHUB_ENV"

          BIN_DIR="$RUNNER_TEMP/fake-bin"
          mkdir -p "$BIN_DIR"
          cat > "$BIN_DIR/claude" <<'EOF'
          #!/bin/sh
          echo "2.0.0 (Claude Code)"
          EOF
          chmod +x "$BIN_DIR/claude"
          echo "$BIN_DIR" >> "$GITHUB_PATH"

      - name: Run install.sh with local binary
        env:
          GIT_AI_LOCAL_BINARY: ${{ github.workspace }}/target/release/git-ai
        run: |
          chmod +x ./install.sh
          ./install.sh

      - name: Verify shell configs and Claude hooks
        run: |
          INSTALL_DIR="$HOME/.git-ai/bin"
          test -x "$INSTALL_DIR/git-ai"
          grep -F "$INSTALL_DIR" "$HOME/.bashrc"
          grep -F "$INSTALL_DIR" "$HOME/.zshrc"
          grep -F "fish_add_path -g \"$INSTALL_DIR\"" "$HOME/.config/fish/config.fish"
          grep -F "checkpoint claude" "$HOME/.claude/settings.json"

  install-local-windows:
    name: Local install.ps1 on windows-latest
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Build git-ai
        run: cargo build --release --bin git-ai

      - name: Prepare test home and fake Claude Code
        shell: pwsh
        run: |
          $testHome = Join-Path $env:RUNNER_TEMP "git-ai-home"
          New-Item -ItemType Directory -Force -Path $testHome | Out-Null
          Add-Content -Path $env:GITHUB_ENV -Value "HOME=$testHome"
          Add-Content -Path $env:GITHUB_ENV -Value "USERPROFILE=$testHome"

          $claudeDir = Join-Path $testHome ".claude"
          New-Item -ItemType Directory -Force -Path $claudeDir | Out-Null

          $binDir = Join-Path $env:RUNNER_TEMP "fake-bin"
          New-Item -ItemType Directory -Force -Path $binDir | Out-Null
          $claudeCmd = Join-Path $binDir "claude.cmd"
          "@echo 2.0.0 (Claude Code)" | Out-File -FilePath $claudeCmd -Encoding ASCII -Force
          Add-Content -Path $env:GITHUB_PATH -Value $binDir

      - name: Run install.ps1 with local binary
        shell: pwsh
        env:
          GIT_AI_LOCAL_BINARY: ${{ github.workspace }}\target\release\git-ai.exe
        run: |
          Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process -Force
          ./install.ps1

      - name: Verify Claude hooks
        shell: pwsh
        run: |
          $installDir = Join-Path $env:HOME ".git-ai\bin"
          if (-not (Test-Path -LiteralPath (Join-Path $installDir "git-ai.exe"))) { throw "git-ai.exe not installed" }
          $settings = Join-Path $env:HOME ".claude\settings.json"
          if (-not (Select-String -Path $settings -Pattern "checkpoint claude")) { throw "Claude hooks not configured" }
